<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <title>
      --- Improving your Rails app load speeds</title><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Improving your Rails app load speeds" />
<meta name="author" content="hyphenized" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1. Add a CDN on top of your application Content delivery networks speed up your application by distributing copies(cached data) of your application responses from locations closer to your users." />
<meta property="og:description" content="1. Add a CDN on top of your application Content delivery networks speed up your application by distributing copies(cached data) of your application responses from locations closer to your users." />
<link rel="canonical" href="/http/nginx/caching/speed/2022/05/15/easy-caching-with-nginx.html" />
<meta property="og:url" content="/http/nginx/caching/speed/2022/05/15/easy-caching-with-nginx.html" />
<meta property="og:site_name" content="hyphenized.dev" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-15T00:25:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Improving your Rails app load speeds" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"hyphenized"},"dateModified":"2022-05-15T00:25:00-05:00","datePublished":"2022-05-15T00:25:00-05:00","description":"1. Add a CDN on top of your application Content delivery networks speed up your application by distributing copies(cached data) of your application responses from locations closer to your users.","headline":"Improving your Rails app load speeds","mainEntityOfPage":{"@type":"WebPage","@id":"/http/nginx/caching/speed/2022/05/15/easy-caching-with-nginx.html"},"url":"/http/nginx/caching/speed/2022/05/15/easy-caching-with-nginx.html"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="hyphenized.dev" /><link rel="shortcut icon" type="image/x-icon" href="" />
    <link rel="stylesheet" href="/assets/css/main.css" />
  </head><body>
    <!--                            ██████████████                                -->
<!--                        ╦███████████████████╦╕         █▓██████▄╦╤        -->
<!--                     ╒█████████████████████████▄      ▐▀███ ██▀███████▄╦╕ -->
<!--                   ╒█████████████████████████████▄   ╒█████▄▄▌▀██╛ █████  -->
<!--                  ╔▓████▄███▄▀████████████████████▓  ████▌█▀████████▐╙╒   -->
<!--                 ╔█████▐██▀███▐█████████▄████▄▐████▌▐████╔╛╛╒▐▐▐▀█████╛   -->
<!--                ╒██████▄███████████████▌███▄██▌████▄▄ ╜▀████▄▄▌▄▀▄████    -->
<!--     ▐▓╦        █████████▓▓▓╧▀▀░░░░▀▀▀██▀████▀███████       ██▀▀█████     -->
<!--     ▐████╤    ▐█████████▀─║░░░     ░░░▒─▀███▓███████      ▐█╛            -->
<!--     ╘███████╦ █████████ ▒  ╙╙╙╙╙╜╜╜░     ─▀█████████     ╒██             -->
<!--      ▀██████████████████ ╙╜╜╜    ┴─▒╖╖╖▒ ▒─█████████     ▓█              -->
<!--       ▀█████████████████▓▄▄              ▄████████▓╛   ╒▄█╛              -->
<!--        ╢██████████████████████▄▄▄▄▄▄▄▄▄███████████▄▄▄█████               -->
<!--         ╚▀███████████████████████████████████████████████╛               -->
<!--           ╫▀████████████████████████████████████████████                 -->
<!--            ▄▒▀███████████████████████████████████████▀╜                  -->
<!--           ╒████████████████████████████████████████▓                     -->
<!--           ██████████████████████████████████████▀                        -->
<!--           ██████████████████████████████████████╛                        -->
<!--          ▐██████████████████████████████████████                         -->
    <main class="page-content" aria-label="Content">
      <div class="container"><header class="site-header">
    <h1><a href="/"><--</a> hyphenized.dev
    </h1><p>Random thoughts and hopefully useful material for you</p><button id="toggler" type="button">TOGGLE</button>
    <script>
        const themes = { dark: "🌙", light: "☀" };
        
        const defaultTheme = (() => {
            const saved = localStorage.getItem("theme");
            return saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        })();

        let currentTheme = defaultTheme;
        toggler.textContent = themes[currentTheme];

        const root = document.querySelector('html');
        root.classList.toggle(currentTheme);

        toggler.onclick = () => {
            const next = currentTheme == "light" ? 'dark' : 'light';
            root.classList.toggle(currentTheme);
            root.classList.toggle(next);

            currentTheme = next;
            toggler.textContent = themes[currentTheme];
            try { localStorage.setItem("theme",currentTheme) } catch (err) {/* noop */}
        }
        window.onload = () => {root.classList.toggle("loaded")}
    </script>
  </header><!-- <a href="/"><--</a> --><article>
  <p class="post-meta">
    <time datetime="2022-05-15 00:25:00 -0500">2022-05-15</time>
  </p>
  
  <h1>Improving your Rails app load speeds</h1>

  <h3 id="1-add-a-cdn-on-top-of-your-application">1. Add a CDN on top of your application</h3>
<p>Content delivery networks speed up your application by distributing copies(cached data) of your application responses from locations closer to your users.</p>

<p>Using a Content Delivery Network should add a small overhead for handling dynamic content requests (<em>since these can’t be cached</em>) and cache misses (<em>which happen when the CDN servers don’t have a cached response yet and have proxy the request to your server</em>). However, it’s almost unnoticeable since CDNs tipically use special kind of servers called <em>edge servers</em> which are <strong>very close</strong> to your users. Consequently, the data coming back to your users spends less time in transit due to requiring less hops to reach their final destination. CDNs greatly reduce overall loading time by caching your application assets/responses across edge servers.</p>

<p>CDNs also have the benefit of providing protection against increased bursts of traffic (in case your application becomes really popular) and DDoS protection. Some of them also offer additional features like compression, to further optimize your assets delivery.</p>

<p>Use something like Cloudfront/Cloudflare. Cloudflare has a generous free tier(Even if you’re planning on build a SaaS). They also have good resources on this topic.</p>

<h3 id="2-reduce-connection-latency-between-serverclients">2. Reduce connection latency between server/clients</h3>
<p>No matter how optimized your application assets are or how fast your internet connection is, when it comes to downloading a bunch of files RTT(Round trip time) is what matters the most. If a request sent from your users device takes as much as 200 ms to reach your server then your users will leave your page before it even finishes loading.</p>

<p>You might argue that your internet speed is very fast, and it might be, but in order to download multiple assets your users browser might need to establish multiple connections at the same time. If each one of those had a RTT of 200ms then a full page load could end up taking around ~1 second for a small website with 5 assets <img class="bttv" src="https://cdn.betterttv.net/emote/583202340ca17361b7e6157f/2x">. It’s actually much more complicated than that but the point is that for most users <a href="https://community.f5.com/t5/technical-articles/rtt-round-trip-time-aka-ndash-why-bandwidth-doesn-rsquo-t-matter/ta-p/275342">latency has a bigger impact than bandwith</a>.</p>

<p>If you’re interested, this is a good read on latency: <a href="http://www.stuartcheshire.org/rants/latency.html">It’s the latency, stupid</a>.</p>

<p>When hosting on a VPS, be sure to choose a datacenter that’s closest to your target audience.</p>

<h3 id="3-delegate-static-assets-serving-to-a-web-server">3. Delegate static assets serving to a web server</h3>
<p>Rails <strong>should not</strong> be handling static asset requests. Ruby is a beautiful language, very fast to code software in, but not as fast to run it. To add to that, the more time your Rails server spends processing requests for static assets, the less it will be able to focus on actually running your application’s logic.</p>

<p>Use something like nginx, there are faster web servers around nowadays but I suspect you should be able to get started quickly. Since most people are familiar with it, you should also be able to get help fast if you have issues while setting it up.</p>

<h3 id="4-use-http320">4. Use HTTP3/2.0</h3>
<p>One of the greatest improvements of <a href="https://web.dev/performance-http2/">HTTP 2.0</a> is request multiplexing, which allows sending multiple requests/responses over a single connection. This eliminates the need for reducing requests with hacks like asset concatenation and image sprites.</p>

<p>HTTP 2.0 is supported by most (if not all) browers nowadays and fully backwards compatible with HTTP 1.1 so there’s very little reason for not including support for it.</p>

<p>HTTP3/ HTTP over QUIC is the newest thing around and it is much faster than HTTP 2 but browser support is still very poor. That being said, some CDNs already support it and if you want to play with it on your server you can do so by following <a href="https://github.com/cloudflare/quiche/tree/master/nginx">this guide</a>. Moreover, since QUIC works over UDP you might need to change your firewall rules.</p>

<h4 id="how-do-i-know-which-protocol-i-am-using">How do I know which protocol I am using?</h4>
<p>Check the network panel on your browser devtools, enable the protocol column and check it’s value, on Chrome the protocol column displays h3 for HTTP3.</p>

<h3 id="5-optimize-bundle-and-minify-assets">5. Optimize, bundle and minify assets</h3>
<p>Most, if not all things under this point are probably covered by something like pagespeed insights. What pagespeed won’t tell you(<em>nor should it have to</em>) is that you shouldn’t serve polyfills for promises if your web application requires devices to support something like WebGL(It doesn’t make much sense). Specifying target browsers will reduce the amount of polyfills and prefixes shipped within your JavaScript/CSS bundles, which in turn will greatly improve load speeds <img class="bttv" src="https://cdn.betterttv.net/emote/5b6ded5560d17f4657e1319e/1x">.</p>

<p>For images/SVGs/videos it depends, sometimes, if the asset is small enough it might make more sense to base64 embed it to prevent an extra request. In the past, before HTTP 2.0 developers would often generate a sprite to load a bunch of small images within a single request but, you probably don’t won’t need to do that nowadays.</p>

<p>Use modern image formats like WebP and include responsive variants, this might be hard to achieve if you have to handle a lot of user submitted images but it is doable. You’ll likely want to enable brotli/gzip compression for text-like assets as well.</p>

<p>Finally, for videos it’s a good idea to focus on bitrate and compression(codec). WebM(VP8/VP9) with a bitrate of at least 3 Mbps has worked well for me.</p>

<h3 id="6-use-conditional-gets-and-good-cache-directives">6. Use conditional gets and good cache directives</h3>
<p>Within your application controllers, you can easily set etags and cache expires using helpers like <code class="language-plaintext highlighter-rouge">fresh_when</code>/<code class="language-plaintext highlighter-rouge">stale_if</code> to minimize the resources spent by your server to process the request.
There’s also partial/fragment caching but I won’t cover that here.</p>

<p>Make sure you don’t cache dynamic content requests outside of Rails. Otherwise you risk having a user see another user’s logged in page (unless that’s what you want <img class="bttv" src="https://cdn.betterttv.net/emote/5de20a2c2dea2902de074598/2x">)</p>

<h3 id="finally-make-sure-to-use-something-like-curl-to-test-that-everything-is-working-the-way-you-expect-it-to">Finally, make sure to use something like curl to test that everything is working the way you expect it to.</h3>

</article>
      </div>
    </main>
  </body>
</html>